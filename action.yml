name: 'gh-merge-base-next Action'
description: 'Automatically find the next commit on the first-parent path from merge-base.'
author: 'srz-zumix'
inputs:
  repo-token:
    description: 'The GitHub token used to manage labels'
    default: ''
    required: false
  repository:
    description: 'The repository in the format owner/repo. If not provided, the repository of the workflow run is used.'
    default: ''
    required: false
  base:
    description: 'The base ref (branch or commit SHA) to find the merge base from.'
    required: true
  head:
    description: 'The head ref (branch or commit SHA) to find the merge base to.'
    required: true

outputs:
  sha:
    description: 'The SHA of the next commit on the first-parent path from the merge-base.'
    value: ${{ steps.merge-base-next.outputs.sha }}
  depth:
    description: 'The number of commits between the merge-base and the next commit on the first-parent path.'
    value: ${{ steps.merge-base-next.outputs.depth }}

runs:
  using: 'composite'
  steps:
    - uses: aquaproj/aqua-installer@11dd79b4e498d471a9385aa9fb7f62bb5f52a73c # v4.0.4
      with:
        aqua_version: v2.55.1
        # policy_allow: aqua-policy.yaml
        working_directory: ${{ github.action_path }}
    - name: gh-merge-base-next path
      id: gh-merge-base-next
      shell: bash
      env:
        GH_HOST: github.com
        GH_ENTERPRISE_TOKEN: ""
        AQUA_POLICY_CONFIG: aqua-policy.yaml
      run: |
        export GH_TOKEN="${AQUA_GITHUB_TOKEN:-}"
        gh-merge-base-next --version
        echo "path=$(aqua which gh-merge-base-next)" >> "${GITHUB_OUTPUT}"
      working-directory: ${{ github.action_path }}
    - name: merge-base-next
      id: merge-base-next
      shell: bash
      env:
        INPUTS_GITHUB_TOKEN: ${{ inputs.repo-token }}
        INPUTS_REPOSITORY: ${{ inputs.repository }}
        INPUTS_BASE: ${{ inputs.base }}
        INPUTS_HEAD: ${{ inputs.head }}
        GH_MERGE_BASE_NEXT: ${{ steps.gh-merge-base-next.outputs.path }}
      run: |
        export GH_TOKEN="${INPUTS_GITHUB_TOKEN:-${GH_TOKEN:-${{ github.token }}}}"
        export GH_ENTERPRISE_TOKEN="${INPUTS_GITHUB_TOKEN:-${GH_ENTERPRISE_TOKEN:-${{ github.token }}}}"

        MERGE_BASE_NEXT_OPTIONS=()
        if [ -n "${INPUTS_REPOSITORY}" ]; then
          MERGE_BASE_NEXT_OPTIONS+=(--repo "${INPUTS_REPOSITORY}")
        fi
        set -x
        "${GH_MERGE_BASE_NEXT}" \
          "${INPUTS_BASE}" "${INPUTS_HEAD}" \
          --format json \
          --template 'sha={{ .sha }}{{ "\n" }}depth={{ .depth }}{{ "\n" }}' \
          "${MERGE_BASE_NEXT_OPTIONS[@]}" >> "${GITHUB_OUTPUT}"

branding:
  icon: 'git-branch'
  color: 'purple'
